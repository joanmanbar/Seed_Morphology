---
title: "Image analysis of Festuca seeds"
author: "Joan M. Barreto O."
date: "4/20/2020"
output: pdf_document
---

```{r include=FALSE, warning=FALSE, message=FALSE}
# Set working directory
# mydir <- dirname(rstudioapi::getSourceEditorContext()$path)
# setwd(mydir)
# library(here)
# set_here(path = ".", verbose = TRUE)

library(dplyr)
library(raster)
library(knitr)
library(ggplot2)
library(doBy)
library(agricolae)
library(scales)
# show_col(hue_pal()(4))

```


\color{black}

# **Methods**

Image analysis was used to explore a potential relationship between seed size and ploidy level in Festuca species. Seeds from each accessions were randomly selected and imaged with an Epson Perfection V6 flatbed scanner at 600 dpi (dots per inch) with size 1987 (width) by 2169 (height) pixels. The TIF images (Tagged Image File Format) were processed with a custom Python script (**https://github.com/joanmanbar/Seed_Morphology**) that transformed the original images to threshold and measure the seed length and width respectively as the length (in pixels) of the major and minor axes of a fitted ellipse, whereas the area is calculated as the number of pixels in the seed. The script returned a dataset containing the image name, the seed number and their dimensional attributes. The data analysis was performed in _R_ (R Core Team, 2014) by fitting liner models with seed area, length, and width as response and the ploidy level as predictor. To remove potential artifacts, we filtered out the seeds that were not within the 45th and 55th quantile. Finally, we used the _ggplot2_ package (Wickham, 2009) for plots and figures.




\
\

## **Preparing the data**

```{r, echo=TRUE}
# Get working directory
mydir <- getwd()

# Read data 
mydata1 <- read.csv(paste0(mydir, '/input/Seeds_data_results.csv'))
ploidy <- read.csv(paste0(mydir, '/input/pic_list_with_ploidy.csv'))
Prev <- read.csv(paste0(mydir, '/input/Previous_data.csv'))
Prev$Image_Name <- as.character(Prev$Image_Name)
Prev$Image_Name <- substr(Prev$Image_Name, 1, 
                            nchar(Prev$Image_Name)-11)
Prev$Image_Name <- as.factor(Prev$Image_Name)
colnames(Prev)[1] <- "Accession"

Prev <- group_by(Prev, Accession)
Prev <- summarise( Prev,
                        sampled_seeds_prev = n(),
                        mean_area_prev = mean(Area, na.rm = TRUE),
                        mean_length_prev = mean(Length, na.rm = TRUE),
                        mean_width_prev = mean(Width, na.rm = TRUE) )


# Remove 5X accessions
ploidy <- ploidy[-which(ploidy$Ploidy == "5X"), ]

# Substract pic number
mydata1$Image_Name <- as.character(mydata1$Image_Name)
mydata1$Image_Name <- substr(mydata1$Image_Name, 1, 
                            nchar(mydata1$Image_Name)-4)
mydata1$Image_Name <- as.factor(mydata1$Image_Name)

ploidy$Image_Name <- as.character(ploidy$Image_Name)
ploidy$Image_Name <- substr(ploidy$Image_Name, 1, 
                            nchar(ploidy$Image_Name)-4)
ploidy$Image_Name <- as.factor(ploidy$Image_Name)

# Merge files
mydata2 <- merge(ploidy, mydata1)
colnames(mydata2)[1] <- "Accession"

# Keep seed with area values around the median
mydata3 <- group_by(mydata2, Accession) %>%
  filter(Area > quantile(Area, 0.45)) %>% filter(Area < quantile(Area, 0.55))
mydata3 <- as.data.frame(mydata3)

# Count total number of seeds per accession
# Total_seeds <- mydata2 %>% group_by (Accession) %>% summarise(n = n())
Total_seeds <- mydata3 %>% group_by (Accession) %>% summarise(n = n())


# Visualize coefficient of variation per accession
Accessions <- group_by(mydata3, Ploidy, Accession)

Accessions <- summarise( Accessions,
                        sampled_seeds = n(),
                        mean_area = mean(Area, na.rm = TRUE),
                        mean_length = mean(Length, na.rm = TRUE),
                        mean_width = mean(Width, na.rm = TRUE) )

write.csv(Accessions, './output/Table_1.csv', row.names = FALSE)

# kable(Accessions, caption = "Coefficient of Variation")

```



## Compare previous against current area size

```{r}
comparison <- merge(Prev, Accessions)
comparison$ratio_area <- comparison$mean_area/comparison$mean_area_prev
comparison$ratio_length <- comparison$mean_length/comparison$mean_length_prev
comparison$ratio_width <- comparison$mean_width/comparison$mean_width_prev

mydata3$Area <- mydata3$Area / mean(comparison$ratio_area)
mydata3$Length <- mydata3$Length / mean(comparison$ratio_length)
mydata3$Width <- mydata3$Width / mean(comparison$ratio_width)

```




\
\

## **Convert pixels to milimiters**

Now we must convert seed dimensions in pixels to mm!
We used this website (https://www.pixelcalculator.com/) to get the conversion factors from px to mm.

```{r, echo=TRUE}

## Convert px to mm at 600dpi --> 600px/inch
# This means that there are 600px per inch, or in a 25.4mm line
# Original Height (or length) = 2169 px (92mm)
# SCANNER: Original Height (or length) = 7019 px (297.2mm or 11.7")

Conv_factor_HW <- 25.4 / 600

# If 25.4mm have 600 px, 25.4^2 (645.16) have 360,000 pixels.
# Therefore, the area, which is given in px, has to be multiplied by 645.16/36000
Conv_factor_area <- (25.4^2) / 360000

mydata3$Area <- mydata3$Area * Conv_factor_area
mydata3$Length <- mydata3$Length * Conv_factor_HW
mydata3$Width <- mydata3$Width * Conv_factor_HW



# Area_sqmm <- 297.2 * 215.9
# Area_px <- 7019*5100
# 
# Area_sqmm/Area_px * 700
# 
# # Conversion factor for area
# CF_area <- 0.5 * ( (600 * 92 / 2169 / 2.54) + (600 * 84 / 1987 / 2.54) )
# 
# H_px <- 7019
# H_mm <- 297.2
# # Original Width = 1987 px (84mm)
# # SCANNER: Original Width = 5100 px (215.9mm or 8.5")
# W_px <- 5100
# W_mm <- 215.9
# # 600 dpi


# mean(mydata3$Area)

# px2mm <- 0.5 * ( W_mm + H_mm )    # Average of both dimensions

# Apply conversion factors


```



\
\

## **Data visualization and analyses of variance**


### **Seed area**
```{r, fig.width = 9}
# Get the code for ggplot colors
ggplot_colors <- hue_pal()(4)



# Mean area of commercial varieties
BEACON_area_mean <- mean(mydata3[which(mydata3$Accession == "BEACON"), "Area"])
QUATRO_area_mean <- mean(mydata3[which(mydata3$Accession == "QUATRO"), "Area"])



# Distribution of the seed area across accessions
bp1 <- ggplot(mydata3, aes(x=Accession, y=Area, fill = Ploidy)) +
geom_boxplot() +
theme_classic() +
theme(axis.text.x = element_text(angle = 90, size = 5)) +
labs(y= expression(paste("Seed Area ", (mm^2))), x = "Accession")

bp1 

ggsave("./output/seed_area_accession.pdf")


# Distrubution across ploidy
vp <- ggplot(mydata3, aes(x=Ploidy, y=Area, color=Ploidy)) +
  geom_violin(trim = FALSE) +
  geom_point(position = position_jitterdodge(seed = 1, dodge.width = 0.9)) + 
  labs(y= expression(paste("Seed Area  ", (mm^2))), x = "Accession") +
  geom_hline(yintercept = QUATRO_area_mean, linetype = 2, color = ggplot_colors[2], size = 1 ) +
  geom_hline(yintercept = BEACON_area_mean, linetype = 2, color = ggplot_colors[3], size = 1) + 
  geom_boxplot(width=0.1, color = 'black', fill = "gray") +
  theme_classic()

vp

# vp <- ggplot(Accessions, aes(x=Ploidy, y=mean_area, color=Ploidy)) +
#   geom_violin(trim = FALSE) +
#   geom_point(position = position_jitterdodge(seed = 1, dodge.width = 0.9)) + 
#   labs(y= expression(paste("Seed Area  ", (mm^2))), x = "Accession") +
#   geom_hline(yintercept = QUATRO_area_mean, linetype = 2, color = ggplot_colors[2], size = 1 ) +
#   geom_hline(yintercept = BEACON_area_mean, linetype = 2, color = ggplot_colors[3], size = 1) + 
#   geom_boxplot(width=0.1, color = 'black', fill = "gray") +
#   theme_classic()
# 
# vp

ggsave("./output/seed_area_ploidy.pdf")



# Model1 <- lm(Area ~ Ploidy + Accession, data = mydata3)
Model1 <- lm(Area ~ Ploidy, data = mydata3)
# summary(Model1)
# kable(anova(Model1))
kable(HSD.test(Model1, "Ploidy")$groups)

```
\
\

### **Seed length**

```{r fig.width = 9}

# Mean length of commercial varieties
BEACON_length_mean <- mean(mydata3[which(mydata3$Accession == "BEACON"), "Length"])
QUATRO_length_mean <- mean(mydata3[which(mydata3$Accession == "QUATRO"), "Length"])

# Distribution of the seed length across accessions
bp2 <- ggplot(mydata3, aes(x=Accession, y=Length, fill = Ploidy)) +
geom_boxplot() +
theme_classic() +
theme(axis.text.x = element_text(angle = 90, size = 5)) +
labs(y= "Seed Length (mm)", x = "Accession")

bp2

ggsave("./output/seed_length_accession.pdf")


# Distrubution across ploidy
vp2 <- ggplot(mydata3, aes(x=Ploidy, y=Length, color=Ploidy)) +
  geom_violin(trim = FALSE) +
  geom_point(position = position_jitterdodge(seed = 1, dodge.width = 0.9)) + 
  labs(y= "Seed Length (mm)", x = "Accession") +
  geom_hline(yintercept = QUATRO_length_mean, linetype = 2, color = ggplot_colors[2], size = 1 ) +
  geom_hline(yintercept = BEACON_length_mean, linetype = 2, color = ggplot_colors[3], size = 1) + 
  geom_boxplot(width=0.1, color = 'black', fill = "gray") +
  theme_classic()

vp2

ggsave("./output/seed_length_ploidy.pdf")



# Regress the seed length on ploidy level
Model2 <- lm(Length ~ Ploidy, data = mydata3)
# summary(Model2)
# kable(anova(Model2))
kable(HSD.test(Model2, "Ploidy")$groups)

```


\
\

### **Seed width**

```{r fig.width = 9}

# Mean width of commercial varieties
BEACON_width_mean <- mean(mydata3[which(mydata3$Accession == "BEACON"), "Width"])
QUATRO_width_mean <- mean(mydata3[which(mydata3$Accession == "QUATRO"), "Width"])

# Distribution of the seed length across accessions
bp2 <- ggplot(mydata3, aes(x=Accession, y=Width, fill = Ploidy)) +
geom_boxplot() +
theme_classic() +
theme(axis.text.x = element_text(angle = 90, size = 5)) +
labs(y= "Seed Width (mm)", x = "Accession")

bp2

ggsave("./output/seed_width_accession.pdf")


# Distrubution across ploidy
vp2 <- ggplot(mydata3, aes(x=Ploidy, y=Width, color=Ploidy)) +
  geom_violin(trim = FALSE) +
  geom_point(position = position_jitterdodge(seed = 1, dodge.width = 0.9)) + 
  labs(y= "Seed Width (mm)", x = "Accession") +
  geom_hline(yintercept = QUATRO_width_mean, linetype = 2, color = ggplot_colors[2], size = 1 ) +
  geom_hline(yintercept = BEACON_width_mean, linetype = 2, color = ggplot_colors[3], size = 1) + 
  geom_boxplot(width=0.1, color = 'black', fill = "gray") +
  theme_classic()

vp2

ggsave("./output/seed_width_ploidy.pdf")





# Regress the seed width using a Type II ANOVA (main effects)
Model3 <- lm(Width ~ Ploidy, data = mydata3)
# summary(Model3)
# kable(anova(Model3))
kable(HSD.test(Model3, "Ploidy")$groups)

```




\
\
\
\

# **Results**
Our results indicate that there are statistical differences in seed area, length and width between four different ploidy levels of Festuca at the $\alpha = 5%$. 

\
\
\
\


\color{red}
# **Notes**
- Please read the methods. 
- These results coincide with the previous results.
- Some accession has more variability than other, do you want to keep them all? Look at the plots and let me know if there is any accession you want to remove or include.
- The Github repository has been updated. I would only talk about the latest Python code in the methods and would not mentioned the Matlab one.
- Let me know if there are some questions or concerns.

\color{black}


\
\
\
\

# **References**

R Core Team (2014). R: A language and environment for statistical computing. R Foundation for Statistical
Computing, Vienna, Austria. URL http://www.R-project.org/

Wickham, H. (2009) ggplot2: elegant graphics for data analysis. Springer New York.



